pro kepler_motion,VEL,FI,PLOT=plot,PATH=path







END
;*****************************************
Rsc=452 & titl=' Akn 120, Rsc=452 ligth days'  ;

;Rsc=963 & titl=' 3C273, Rsc=963 ligth days'  ;
;Rsc=38 & titl=' NGC4051, Rsc=38 ligth days'
;Rsc=1130 & titl='IRAS13349+2438 , Rsc=1130 ligth days'
;Rsc=142 & titl='Mkn335 , Rsc=142 ligth days'
;Rsc=60& titl=' NGC5548, Rsc=60 ligth days'
;Rsc=44 & titl=' NGC4151, Rsc=44 ligth days'
;Rsc=180 & titl=' Mkn817, Rsc=180 ligth days'
 ;
;*****************************************

crsz=1.2
;obj='Mkn110_151207' & Rsc=100 & titl=' Mkn110, Rsc=100 ligth days' & z=0.035291 & dv=0 & dFI=0 & sign=-1
;obj='Mkn79_141020' & Rsc=55 & titl=' Mkn79, Rsc=55 ligth days' & z=0.022189 & dv=0 & sign=-1
;obj='NGC4593_150318' & Rsc=43 & titl=' NGC4593, Rsc=43 ligth days' & z=0.009001 & dv=0 & sign=-1
;obj='PG1700+518_160405' & Rsc=687 & titl='PG1700+518_160405, Rsc=687 ligth days' & z=0.2890 & dv=0 & sign=1 &  Vmax=15e3 & dFI=-15 & Vmin=0 & TRESH=2 & V_min=3e3 &  V_max=10e3
;obj='MCG+08-11-011_151106' & Rsc=687 & titl='MCG+08-11-011, Rsc=90 ligth days' & z=0.020484 & dv=0
;obj='3c390_140529' & Rsc=119 & titl='3c390.3, Rsc=119 ligth days' & z=0.0561 & dv=0


;obj='E1841+643' & Rsc=2161 & titl='E1841+643, Rsc=2161 ligth days' & z=0.297
;obj='3C120_131106' & Rsc=452 & titl=' Akn 120, Rsc=452 ligth days'  ;
;obj='Mkn335_131109' & Rsc=142 & titl='Mkn335 , Rsc=142 ligth days'& z=0.027& sign=1 & dv=0 & Vmax=10e3 & dFI=0 & Vmin=0 & TRESH=2 & V_min=3e3 &  V_max=6e3 & TETA=0 & kep=1 & dN=8
;obj='Mkn1148_141120' & Rsc=232 & titl='Mkn1148 , Rsc=232 ligth days'& z=0.066& sign= -1 & dv=1e3 & Vmax=15e3 & dFI=0 & Vmin=0 & TRESH=3& V_min=3e3 &  V_max=6e3 & TETA=0 & kep=1 & dN=8
;obj='Mrk1502_141122' & Rsc=93 & titl='Mkn1502 , Rsc=93 ligth days'& z=0.061 & sign=-1 & dv=1e3& Vmax=15e3 & dFI=0 & Vmin=0 & TRESH=2 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=1
;;;;obj='IRAS03450_141020' & Rsc=90 & titl='IRAS03450 , Rsc=118 ligth days'& z=0.032 & sign=-1 & dv= 0 & Vmax=5e3 & dFI=0 & Vmin=0 & TRESH=3 & V_min=3e3 &  V_max=5e3 & TETA=0 & Kep=1
;obj='3C120_131106' & Rsc=223 & titl='3C120, Rsc=223 ligth days' & z=0.0340 & sign=-1 & dv= 1000 & Vmax=10e3 & dFI=0 & Vmin=1000 & TRESH=3 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=1
;obj='Akn120_140324' & Rsc=452 & titl='Akn120, Rsc=452 ligth days' & z=0.034 & sign=1 & dv=0 & Vmax=10e3 & dFI=0 & Vmin= 500 & TRESH=3 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=-1
;obj='MCG+08-11-011_151106' & Rsc=179 & titl='MCG+08-11-011, Rsc=179 ligth days' & z=0.022 & sign=1 & dv= 0 & Vmax=15e3 & dFI=0 & Vmin=  1e3 & TRESH=3 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep= 1
;obj='Mkn79_151207' & Rsc=71 & titl=' Mkn79, Rsc=71 ligth days' & z=0.024  & sign=-1 & dv= 0 & Vmax=15e3 & dFI=0 & Vmin=  1e3 & TRESH=3 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=1
obj='PG0844+349_141121' & Rsc=236 & titl='PG0844+349, Rsc=236 ligth days' & z=0.066 & dv=300 & sign=-1 & Vmax=14e3 & dFI=0 & Vmin=0 & TRESH=3& V_min=3e3 &  V_max=6e3 & TETA=0 & Kep=1 & d_FI=0
;obj='Mkn704_141123' & Rsc=98 & titl='Mkn704, Rsc=98 ligth days' & z=0.031  & sign=-1 & dv= 0 & Vmax=20e3 & dFI=0 & Vmin=  1e3 & TRESH=3 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=-1 & d_FI=0
;obj='Mkn110_151207' & Rsc=171 & titl='Mkn110, Rsc=171 ligth days' & z=0.037  & sign=-1 & dv=  0 & Vmax=20e3 & dFI=0  & Vmin=  0 & TRESH=2 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=-1
;obj='NGC3227_151210' & Rsc=22 & titl='NGC3227, Rsc=22 ligth days' & z=0.0050 & sign=-1 & dv= 500 & Vmax=15e3 & dFI=0 & Vmin=  0 & TRESH=2 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=1
;obj='MKn744_160307' & Rsc=51  & titl='Mkn744, Rsc=51 ligth days' & z=0.0089  & sign=1 & dv= 500 & Vmax=15e3 & dFI=0 & Vmin=  0 & TRESH=2 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=-1 & dN=4 & d_FI=0
;obj='NGC4151_140523' & Rsc=44  & titl='NGC4151, Rsc=44 ligth days' & z=0.0033  & sign=1 & dv=0  & Vmax=7e3 & dFI=-10 & Vmin=  0 & TRESH=3 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=1

;obj='NGC4051_140324' & Rsc=22  & titl='NGC4051, Rsc=22 ligth days' & z=0.0024 & sign=-1 & dv=0  & Vmax=5e3 & dFI=0 & Vmin=  0 & TRESH=3 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=1
;obj='3C273_140325' & Rsc=963 & titl='3C273, Rsc=963 ligth days' & z=0.16  & sign=-1 & dv= 000 & Vmax=15e3 & dFI=0 & Vmin=  0 & TRESH=2 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=1 &  d_FI=-0 & dN=8
;obj='NGC4593_150318' & Rsc=67 & titl=' NGC4593, Rsc=67 ligth days' & z=0.009001& sign=1 & dv= 500 & Vmax=5e3 & dFI=0 & Vmin=  0 & TRESH=2 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=1 &  d_FI=-0
;obj='Mkn231_150318' & Rsc=304 & titl=' Mkn231, Rsc=304 ligth days' & z=0.044& sign=1 & dv= 500 & Vmax=10e3 & dFI=0 & Vmin=1e3 & TRESH=3 & V_min=3e3 &  V_max=10e3 & TETA=0 & Kep=1 &  d_FI=-0
;obj='IRAS13349+2438_140523' & Rsc=1130 & titl='IRAS13349+2438 , Rsc=1130 ligth days' & z=0.109  & sign=1 & dv=500 & Vmax=15e3 & dFI=0 & Vmin=500 & TRESH=2 & V_min=1e3 &  V_max=10e3 & TETA=0 & Kep=-1 &  d_FI=-0
;obj='Mkn668_150324' & Rsc=53 & titl='Mkn668 , Rsc=53 ligth days' & z=0.0766 & sign=1 & dv=500 & Vmax=20e3 & dFI=0 & Vmin=500 & TRESH=3 & V_min=1e3 &  V_max=10e3 & TETA=0 & Kep= 1 &  d_FI=-0
;obj='Mkn817_140529' & Rsc=180 & titl='Mkn817 , Rsc=180 ligth days' & z=0.032 & sign=-1 & dv=500 & Vmax=10e3 & dFI=0 & Vmin=500 & TRESH=3& V_min=1e3 &  V_max=10e3 & TETA=0 & Kep= 1 &  d_FI=-0
;obj='Mkn841_140529' & Rsc=182 & titl='Mkn841 , Rsc=182 ligth days' & z=0.038 & sign=-1 & dv=500 & Vmax=20e3 & dFI=0 & Vmin=500 & TRESH=2 & V_min=1e3 &  V_max=10e3 & TETA=0 & Kep= 1 &  d_FI=-0
;obj='Mkn876_160408' & Rsc=254 & titl='Mkn876 , Rsc=254 ligth days' & z=0.129 & sign=1 & dv=00 & Vmax=20e3 & dFI=0 & Vmin=500 & TRESH=2 & V_min=1e3 &  V_max=10e3 & TETA=0 & Kep=1 &  d_FI=-0
;obj='PG1700+518_160405' & Rsc=277 & titl='PG1700+518 , Rsc=277 ligth days' & z=0.29  & sign=-1 & dv=00 & Vmax=20e3 & dFI=0 & Vmin=0 & TRESH=2 & V_min=1e3 &  V_max=10e3 & TETA=0 & Kep= 1 &  d_FI=0
;obj='Mkn509_141021' & Rsc=209 & titl='Mkn509 , Rsc=209 ligth days' & z=0.036 & sign=1 & dv=2e3 & Vmax=20e3 & dFI=0 & Vmin=500 & TRESH=3 & V_min=1e3 &  V_max=10e3 & TETA=0 & Kep=  1 &  d_FI=0
;obj='Mkn304_131109' & Rsc=255 & titl='Mkn304 , Rsc=255 ligth days' & z=0.0662 & sign=-1 & dv=1e3 & Vmax=10e3 & dFI=0 & Vmin=500 & TRESH=3 & V_min=1e3 &  V_max=30e3 & TETA=0 & Kep= -1 &  d_FI=-0
;obj='3C445_141113' & Rsc=650 & titl='3C445 , Rsc=650 ligth days' & z=0.0559 & sign=1 & dv=1e3 & Vmax=10e3 & dFI=0 & Vmin=500 & TRESH=3 & V_min=1e3 &  V_max=10e3 & TETA=0 & Kep= 1 &  d_FI=-0
;obj='NGC5548_140325' & Rsc=114 & titl='NGC5548 , Rsc=114 ligth days' & z=0.0172 & sign=1 & dv=00 & Vmax=20e3 & dFI=0 & Vmin=500 & TRESH=3 & V_min=1e3 &  V_max=10e3 & TETA=0 & Kep= 1 &  d_FI=-0 & dN=4
;obj='3c390_140529' & Rsc=190 & titl='3c390.3, Rsc=190 ligth days' & z=0.053 & dv=5e3 & Vmax=20e3 &dFI=0 & Vmin=500 & TRESH=2 & V_min=1e3 &  V_max=10e3 & TETA=0 & Kep=-1 &  d_FI=-0 & dN=4
;;;чтение таблицы RES
dir='H:\red_data.pol\Sy1\'

tab=read_table(dir+obj+'\'+obj+'.res')
Ntab=N_elements(tab)-1
wave=fltarr(Ntab) & avg_FI=wave & avg_Q=wave  & avg_U=wave & avg_F=wave  & P=wave &
for  j=0,Ntab-1 do begin

wave(j)=FLOAT(strmid(tab(j+1),0,4))
avg_F(j)=FLOAT(strmid(tab(j),5,12))/FLOAT(strmid(tab(j),40,6))*100
avg_Q(j)=FLOAT(strmid(tab(j+1),17,5))/100
avg_U(j)=FLOAT(strmid(tab(j+1),29,5))/100
avg_FI(j)=strmid(tab(j+1),53,7)
;avg_FI(j)=calc_atan(avg_Q(j),avg_U(j))/2
;print,wave(j),avg_Q(j),avg_U(j),avg_FI(j)
endfor

;RFI=where(avg_FI lt 90) & avg_FI(RFI)=avg_FI(Rfi)+135

;чтение таблицы TXT
;dir='h:\red_data.pol\AGN\publish_AGN\'
;Ntab=numlines(dir+obj+'.txt')
;tab=fltarr(2,Ntab)r
;wave=fltarr(Ntab) & avg_FI=wave
;openr,1,dir+obj+'.txt'
;readf,1,tab
;close,1
;wave(*)=tab(0,*) & avg_FI(*)=tab(1,*)
;*********************************************
;определение наклона поляризации континума
V=5100*(1+z) & d_V=1000
Rv=where(ABS(wave-V) lt d_V)

Pol=SQRT(avg_Q^2+avg_U^2)*100

f=goodpoly(Alog10(wave(Rv)),ALOG10(Pol(Rv)),1,2,Yfit,newx,newy)
robomean,10^newy,1,0.5,avg_Pol,rms_Pol
print,avg_Pol,rms_Pol
f=poly_fit(newx,newy,1,fit,sigma=S)
avg_n=f(1)  & rms_n=s(1)/3
window,3,xsize=550,ysize=400,ypos=0,xpos=700
!P.multi=[0,1,1]
plot,10^newx,10^newy,xst=1,psym=6,yrange=[0,2],$
	title='P='+string(avg_Pol,format='(F5.2)')+'!9+!3'+$
	string(rms_Pol,format='(F4.2)')+'%'+$
	',  n='+string(avg_n,format='(F6.2)')+'!9+!3'+$
	string(rms_n,format='(F4.2)')
oplot,10^newx,10^fit



;определение уровня континуума на 5100
cont=5100*(1+z)  & d_cont=50*(1+z)
Rc=where(ABS(wave-cont) lt d_cont)
robomean,avg_F(Rc),3,0.5,avg_cont,rms_cont
print,'cont_5100=',avg_cont,'    +/-',rms_cont
;вычисление потока в Ha в единицах континуума на 5100
;avg_F=avg_F/avg_cont
Ha=(6563)*(1+z)  & print,'Ha*(1+z)',Ha
d_wave=Vmax*Ha/3e5

R=where(ABS(wave-Ha) lt d_wave,Nw) & print,Nw
wave=wave(R)


avg_FI=avg_FI(R) & avg_Q=avg_Q(R) & avg_U=avg_U(R) & avg_F=avg_F(R)
robomean,avg_Q*avg_F,3,0.5,Q_cont
robomean,avg_U*avg_F,3,0.5,U_cont
;Q_cont=0 & U_cont=0
Vel=((wave-Ha)/Ha*3e5);+dV



set_plot,'WIN'
crsz=0.75
window,0,xsize=500,ysize=750
& dN=30
!p.multi=[0,1,1]
;определение уровня континуума
N=N_elements(vel)
CF=goodpoly([vel(0:N/4),vel(N-N/4:N-1)],[avg_F(0:N/4),avg_F(N-N/4:N-1)],1,3)
cont_F=CF(0)+CF(1)*vel
;вычисление потока в Ha в единицах континуума на 5100
Flux_Ha=total(avg_F-cont_F)/avg_cont
;определение полуширины линии
prof_Ha=(avg_F-cont_F)/avg_cont &
NN=N_elements(avg_F)
mean_F=LOWESS(findgen(NN),prof_Ha,NN/dN,2,2)
RP=where(mean_F gt max(mean_F)/2,ind)
FWHM_Ha=ind*(Vel(1)-Vel(0))
err_FWHM_Ha=ABS(Vel(1)-Vel(0))
;Flux
avg_F=avg_F/avg_cont
order_F=FIX(ALOG10(max(avg_F)))
order_F=0
plot,vel,avg_F/10^order_F,xst=1,charsize=crsz,psym=10,$
	title='Flux(H!7a!3)/Flux(5100)='+string(Flux_Ha,format='(F5.1)')+$
	',    FWHM(H!7a!3)='+string(FWHM_Ha,format='(I5)')+'!9+!3'+string(err_FWHM_Ha,format='(I3)')+' km/s',$
	yrange=[0.001,1]*max(avg_F)*1.1/10^order_F,yst=1,$
	position=[0.08,0.78,0.99,0.96],xcharsize=1e-5
	xyouts,0.025,0.87,'Total Flux',$

	/norm,align=0.5,orientation=90,charsize=crsz
	oplot,vel,cont_F/avg_cont,linestyle=2
	oplot,[0,0],[-1,1]*1e3,linestyle=1

oplot,vel,mean_F+cont_F/avg_cont , color=3e5
;Q-Stokes

plot,vel,avg_Q*avg_F,xst=1,charsize=crsz,psym=10,$
	position=[0.08,0.60,0.99,0.78],xcharsize=1e-5,/noerase
	xyouts,0.025,0.69,'Q-Stoks Flux',$
	/norm,align=0.5,orientation=90,charsize=crsz
	oplot,[min(vel),max(vel)],[1,1]*Q_cont,linestyle=2
	oplot,[0,0],[-1,1]*1e3,linestyle=1
;U-Stokes

plot,vel,avg_U*avg_F,xst=1,charsize=crsz,psym=10,$
      ;yrange=[-1,1]*max(ABS(avg_U))*avg_F*1.3/10^order_U,yst=1,$
   	position=[0.08,0.42,0.99,0.60],xcharsize=1e-5,/noerase
	oplot,[min(vel),max(vel)],[1,1]*U_cont,linestyle=2
	oplot,[0,0],[-1,1]*1e3,linestyle=1
	xyouts,0.025,0.51,'U-Stoks Flux',$
	/norm,align=0.5,orientation=90,charsize=crsz
print,'QU cont', Q_cont,U_cont
;Polarized Flux
Q=(avg_Q*avg_F-Q_cont) & U=(avg_U*avg_F-U_cont)

avg_P=sqrt(avg_Q^2+avg_U^2)*100;*avg_F
plot,vel,avg_P ,xst=1,charsize=crsz,psym=10,$
	position=[0.08,0.24,0.99,0.42],xcharsize=1e-5,/noerase
	oplot,[0,0],[-1,1]*1e3,linestyle=1
	xyouts,0.025,0.33,'Degree of Polarized, %',$
		/norm,align=0.5,orientation=90,charsize=crsz
;Angle of Polarization
f=goodpoly(vel,avg_FI,1,3,Fit)
avg_FI=avg_FI-fit
plot,vel,avg_FI,xst=1,charsize=crsz,psym=10,$
	xtitle='Velocity, km/s',$
	position=[0.08,0.06,0.99,0.24] ,/noerase
	NN=N_elements(avg_FI) & dN=30
	robomean,[avg_FI(0:dN),avg_FI(NN-dN-1)],3,0.5,level_FI
	oplot,[min(vel),max(vel)],[1,1]*level_FI,linestyle=2
	oplot,[0,0],[-1,1]*1e3,linestyle=1
	xyouts,0.025,0.15,'Angle of Polarization, deg',/norm,align=0.5,orientation=90,charsize=crsz


;*************************************
;построение QU-диаграммы
;******************************************************
window,1,xsize=550,ysize=550,xpos=700,ypos=550
!P.multi=[0,1,1]
Ampl=0.015
plot,[-1,1]*Ampl,[-1,1]*Ampl,xst=1,yst=1,/nodata,position=[0.1,0.1,0.995,0.995],/norm
;R=where(vel gt 2e3 and U lt -0.2 ) & Q(R)=0 & U(R)=0

RPL=where(vel gt 0 and vel lt  V_min) & RPH= where(vel gt  V_min and vel lt  V_max)
RNL=where(vel lt 0 and vel gt -V_min) & RNH= where(vel lt -V_min and vel gt -V_max)
FI=findgen(32)*!PI/16 & FI=[FI,FI(0)]
USERSYM,cos(FI),sin(FI)
Q=avg_Q  & U=avg_U
oplot,Q(RPL),U(RPL),psym=8
oplot,Q(RPH),U(RPH),psym=8,symsize=1.5,color=1e5

USERSYM,cos(FI),sin(FI),/fill
oplot,Q(RNL),U(RNL),psym=8
oplot,Q(RNH),U(RNH),psym=8 ,symsize=1.5,color=1e5
oplot,[-1,1]*Ampl,[0,0],linestyle=2
oplot,[0,0],[-1,1]*Ampl,linestyle=2
PA=2*level_FI-90
oplot,[-sin((PA)/180.*!PI),sin((PA)/180.*!PI)]*ampl,[1,-1]*ampl,linestyle=1
R_e=1* ampl  & a=6
x_e=cos(FI)*R_e & y_e=sin(FI)*R_e/a
ROT_XY, X_e, Y_e,PA , 0, 0, X_e, Y_e,  /degrees
oplot,x_e,y_e,linestyle=1
;*************************************************
 print,'dV',dV
;*************************************************
FI_cont=level_FI
Vel=((wave-Ha)/Ha*3e5)+dV
avg_FI=avg_FI-FI_cont-dFI

f=goodpoly(vel,avg_FI,1,2,fit)
;avg_FI=avg_FI-fit
avg_FI=avg_FI+d_FI
;R=where(avg_fi lt -10) & avg_FI(R)=-3
;Avg_FI(R)=Avg_FI(R)+10


set_plot,'WIN'
;VE__VS_TAN

key_plot=1
if key_plot eq 0 then Window,2,xsize=600,ysize=900
!P.multi=[0,1,2]
if key_plot eq 1 then begin
set_plot,'PS'
device,file=dir+obj+'\Angle_VS_Vel.eps',xsize=8,ysize=12,/encapsulated;,xoffset=2,yoffset=4
endif
if key_plot eq 2 then begin
set_plot,'PRINTER'
device,scale_factor=1
endif

!P.multi=[0,1,2]
;goto,fin
;***********************************************
;зависимость LOG(v/c))_VS_log(tan(FI))
;***********************************************
RL=where(Vel lt -Vmin,ind_RL)  & RR=where(Vel gt Vmin,ind_RR)
print,ind_RL,ind_RR
;учет наклона

avg_FI=avg_FI*sign

T=TAN(avg_FI*!PI/180)
d_V=0
;rms_T=rms_FI/180.*!PI/(cos(rms_FI/180.*!PI))^2
VR=VEL(RR)/3e5   & TR=-T(RR) & ;rms_TR=rms_T(RR)
R=where(TR gt 0.0) & TR=TR(R) & VR=VR(R)  & ;rms_TR=rms_TR(R)
VL=-VEL(RL)/3e5   & TL=T(RL) & ;rms_TL=rms_T(RR)
R=where(TL gt 0,ind)
if ind gt 0 then begin
TL=TL(R)  & VL=VL(R) & ;rms_TL=rms_TL(R)
endif

A=-2.5 & B=-0.5

f=goodpoly([ALOG10(TL),ALOG10(TR)],[ALOG10(VL),ALOG10(VR)],1,2,Fit)
print,'f: ',f(0),f(1)
d_logV=0
LogT=[ALOG10(TL),ALOG10(TR)] & LogV=[ALOG10(VL)+d_logV,ALOG10(VR)-d_logV]
LogV_Kepler=A+B*LogT

robomean,LogV-LogV_Kepler,tresh,0.5,avg_A,rms_A
rms_A=rms_A/2
avg_A=A+avg_A
avg_A=-2.11  & rms_A=0.11
print,avg_A,rms_A

crsz=0.7

smz=0.5
;avg_A=avg_A-0.3
if Rsc ne 0 then begin
Log_M_BH=ALOG10(1.78)+10+2*avg_A+ALOG10(Rsc)
;Log_M_BH=ALOG10(0.58)+10+2*avg_A +ALOG10(Rsc)
err_Log_M_BH=2*rms_A
print,Log_M_BH,err_Log_M_BH
endif

LogV_Kepler=avg_A+B*LogT
;
plot,Vel,-avg_FI,xst=1 ,charsize=crsz,yrange=[-10,10]*8,$
	title=titl,xtickformat='(I6)',psym=10,xtitle='Velocity, km/s',ytitle='!7D!9P!3'
oplot,[-1,1]*2e4,[1,1]*45,linestyle=1
oplot,[-1,1]*2e4,-[1,1]*45,linestyle=1
xyouts,0,80,'broad H!7a!3',align=0.5,charsize=1
oplot,[0,0] ,[-1,1]*100,linestyle=2
oplot,[-1,1]*2e4,[0,0],linestyle=2
print,'sign ',sign
if key_plot eq  0 then col=4e4 else col=150
RPOS=WHERE(Vel gt Vmin)  & RNEG=WHERE(Vel lt -Vmin)
M_BH=Log_M_BH

FI_Kepler=(ATAN(10.0^(-2*avg_A)*Vel(RPOS)^2/9E10/2)*180/!PI-90)/2
oplot,Vel(RPOS),-FI_Kepler*Kep ,color=col,thick=10
FI_Kepler=(90-ATAN(10.0^(-2*avg_A)*Vel(RNEG)^2/9E10)*180/!PI)/2

oplot,Vel(RNEG),-FI_Kepler*Kep  ,color=col,thick=10
oplot,Vel,-avg_FI,psym=10 & oplot,[-1,1]*2e4,[0,0],linestyle=2
oplot,Vel(RR),-avg_FI(RR),psym=10,thick=2
oplot,Vel(RL),-avg_FI(RL),psym=10,thick=2


dd_V=-0.09
d_V=0.05

TETA=findgen(32)*!PI/16 & teta=[teta,teta(0)]
USERSYM,cos(teta) ,sin(teta)
R=where(ABS(ALOG10(VR)-avg_A-B*ALOG10(TR)) lt tresh*rms_A)

TR_out=ALOG10(TR(R)) & VR_out=ALOG10(VR(R))-d_V+dd_V & print,N_elements(TR_out)

openw,1,dir+'TR.txt'
for i=0,21 do printf,1,TR_out(i),VR_out(i)
close,1
plot,TR_out,VR_out,psym=8,yrange=[-3,0],charsize=crsz,$
	title='Log(V/c) = a + 0.5 Log(tan!9P!3)',symsize=smz,$
	xtickinterval=1,xtitle='Log(tan!9P!3)',ytitle='Log(V/c)',xrange=[-3,0.5],xst=1
oplot,[-2.75],[-2.47],psym=8,symsize=smz
xyouts,[-2.85],[-2.52],'( ) - Velocity > 0',charsize=crsz
R=where(ABS(ALOG10(VL)-avg_A-B*ALOG10(TL)) lt tresh*rms_A)
TL_out=ALOG10(TL(R)) & VL_out=ALOG10(VL(R))+d_V+dd_V & print,N_elements(TL_out)
openw,1,dir+'TL.txt'
for i=0,38 do printf,1,TL_out(i),VL_out(i)
close,1
USERSYM,cos(teta),sin(teta),/fill
oplot,TL_out,VL_out,psym=8,symsize=smz
oplot,[-2.75],[-2.67],psym=8,symsize=smz
xyouts,[-2.85],[-2.72],'( ) - Velocity < 0',charsize=crsz
index=sort(LogT)
oplot,LogT(index),LogV_Kepler(index)+dd_V,linestyle=2
avg_A=-2.14 & rms_A=0.11  & Log_M_BH=8.35 & err_Log_M_BH=0.26

xyouts,-1.3,-0.3,'a = '+string(avg_A,format='(F5.2)')+'!9+!3'+string(rms_A,format='(F4.2)'),$
	charsize=crsz ,align=0.5

if Rsc ne 0 then xyouts,-1.3,-0.7,'Log(M!DBH!N/M!D!9n!N!3)='$
	+string(Log_M_BH,format='(F5.2)')+'!9+!3'+string(err_Log_M_BH,format='(F5.2)'),$
	charsize=crsz ,align=0.5
arrow,0,-1.5,0,-2,color=0,/data
xyouts,0,-1.3,'!9P!3!Bmax!N',/data,align=0.5,charsize=crsz
if key_plot gt 0  then device,/close

set_plot,'WIN'
end